# 优化的Agentic RAG工作流

## 架构升级

从原来的5阶段工作流优化为更高效的**4阶段SequentialAgent工作流**，引入**80%质量阈值**控制机制。

## 工作流程

### 1. 查询重写 (QueryRewriterAgent)
- **功能**: 优化用户查询表述，提高检索效果
- **策略**: 
  - 提取核心法律概念和关键词
  - 规范法律术语表述
  - 生成多个查询变体提高召回率
- **输出**: `rewritten_query` - 包含主查询和备选查询

### 2. 检索执行 (RetrievalAgent)
- **功能**: 基于重写后的查询执行法律条文检索
- **策略**:
  - 优先使用主查询进行检索
  - 结果不足时尝试备选查询
  - 合并去重并按相关性排序
- **输出**: `retrieval_results` - 格式化的检索结果

### 3. 质量评估 (QualityEvaluatorAgent) ⭐
- **功能**: 评估检索质量并进行阈值判断
- **评估维度** (每项10分):
  - 相关性：检索结果与查询的匹配程度
  - 完整性：是否包含足够信息回答问题
  - 准确性：法律条文的准确性和权威性
  - 覆盖面：结果的多样性和全面性
- **阈值控制**: **总分≥8.0分(80%)** 才能继续生成答案
- **输出**: `quality_evaluation` - 包含PASS/FAIL判断

### 4. 答案生成 (AnswerGeneratorAgent)
- **功能**: 基于质量阈值判断生成专业法律咨询
- **控制逻辑**:
  - ✅ **PASS**: 生成专业法律咨询答案
  - ❌ **FAIL**: 输出标准回复，建议用户重新描述或咨询律师
- **输出**: `final_answer` - 最终法律咨询结果

## 核心优势

### 1. 🎯 **提高检索精度**
- 查询重写优化用户表述
- 多变体查询提高召回率
- 智能合并去重机制

### 2. 🛡️ **质量阈值控制**
- 80%阈值确保答案质量
- 避免基于低质量检索生成答案
- 多维度评估保证准确性

### 3. ⚡ **流程高效化**
- 从5阶段精简为4阶段
- 消除冗余的双重评估
- 基于阈值的早期终止

### 4. 🔒 **安全防护机制**
- 多层检查防止空结果处理
- 严格的质量控制标准
- 明确的失败处理策略

## 使用方式

### 1. 基本使用
```python
from agentic_rag.optimized_workflow_agent import optimized_agentic_rag_workflow

# 工作流已配置为root_agent，可直接在ADK Web中使用
```

### 2. 测试验证
```bash
python test_optimized_workflow.py
```

### 3. 阈值调整
如需调整质量阈值，修改`QualityEvaluatorAgent`中的阈值设置：
```python
# 当前设置：≥8.0分(80%)
# 可根据需要调整为其他值，如7.0分(70%)或9.0分(90%)
```

## 文件结构

```
agentic_rag/
├── optimized_workflow_agent.py  # 优化的4阶段工作流
├── agent.py                     # ADK入口文件(已更新)
├── test_optimized_workflow.py   # 测试文件
└── README_OPTIMIZED_WORKFLOW.md # 本文档
```

## 对比分析

| 维度 | 原5阶段流程 | 优化4阶段流程 |
|------|-------------|---------------|
| **阶段数** | 5个Agent | 4个Agent |
| **质量控制** | 双重评估 | 单一阈值控制 |
| **效率** | 较低 | 高效 |
| **准确性** | 依赖指令 | 量化阈值判断 |
| **可控性** | 有限 | 强(80%阈值) |

## 测试结果

✅ 所有测试通过  
✅ 工作流配置正确  
✅ 阈值机制有效  
✅ 状态变量引用正确  

优化后的工作流在保证质量的同时显著提升了效率和可控性。
